<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="color-scheme" content="light dark" />
        <title>群聊分析报告</title>
        <link rel="stylesheet" href="./css/template_group.css" />
        <script src="https://cdnjs.onmicrosoft.cn/ajax/libs/color-thief/2.6.0/color-thief.umd.js"></script>
        <script type="importmap">
            {
                "imports": {
                    "@material/material-color-utilities": "https://npm.onmicrosoft.cn/@materialx/material-color-utilities@0.4.8"
                }
            }
        </script>
    </head>
    <body>
        <img id="dynamic-color-source" src="${dynamicAvatarUrl}" alt="" />
        <div class="container">
            <div class="header">
                <h1>群聊分析报告</h1>
                <div class="sub-title">${groupName} | ${analysisDate}</div>
            </div>

            <div class="summary">
                <div class="summary-item">
                    <div class="label">总消息数</div>
                    <div class="value">${totalMessages}</div>
                </div>
                <div class="summary-item">
                    <div class="label">参与人数</div>
                    <div class="value">${totalParticipants}</div>
                </div>
                <div class="summary-item">
                    <div class="label">总字数</div>
                    <div class="value">${totalChars}</div>
                </div>
                <div class="summary-item">
                    <div class="label">最活跃时段</div>
                    <div class="value">${mostActivePeriod}</div>
                </div>
            </div>

            <div class="section-title">龙王榜</div>
            <div class="card-grid two-columns">${userStats}</div>

            <div class="section-title">群友称号</div>
            <div class="card-grid two-columns">${userTitles}</div>

            <div class="section-title">热门话题</div>
            <div class="card-grid">${topics}</div>

            <div class="section-title">本群圣经</div>
            <div class="card-grid">${goldenQuotes}</div>

            <div class="section-title">24小时活跃分布</div>
            ${activeHoursChart}

            <footer>由 Koishi & ChatLuna 强力驱动</footer>
        </div>

        <script type="module">
            import * as material_color_utilities from '@material/material-color-utilities'

            const colorThief = new ColorThief()
            const {
                themeFromSourceColor,
                argbFromRgb,
                Hct,
                DynamicScheme,
                SpecVersion,
                Variant
            } = material_color_utilities

            const body = document.body
            const root = document.documentElement
            const themeSetting = '${theme}'
            const defaultSourceColor = [103, 80, 164]

            function applyTheme(themeName) {
                body.className = themeName + '-theme'
            }

            function setCssVariable(variable, value) {
                root.style.setProperty(variable, value)
            }

            function applyDynamicColors(color) {
                try {
                    const isDark = body.classList.contains('dark-theme')
                    const sourceArgb = argbFromRgb(color[0], color[1], color[2])

                    const scheme = DynamicScheme.from({
                        isDark,
                        specVersion: SpecVersion.SPEC_2025,
                        // variant: Variant.EXPRESSIVE,
                        sourceColorHct: Hct.fromInt(sourceArgb)
                    })

                    const tokenMap = {
                        primary: 'primary',
                        'on-primary': 'onPrimary',
                        'primary-container': 'primaryContainer',
                        'on-primary-container': 'onPrimaryContainer',
                        secondary: 'secondary',
                        'on-secondary': 'onSecondary',
                        'secondary-container': 'secondaryContainer',
                        'on-secondary-container': 'onSecondaryContainer',
                        tertiary: 'tertiary',
                        'on-tertiary': 'onTertiary',
                        'tertiary-container': 'tertiaryContainer',
                        'on-tertiary-container': 'onTertiaryContainer',
                        error: 'error',
                        'on-error': 'onError',
                        'error-container': 'errorContainer',
                        'on-error-container': 'onErrorContainer',
                        background: 'background',
                        'on-background': 'onBackground',
                        surface: 'surface',
                        'on-surface': 'onSurface',
                        'surface-dim': 'surfaceDim',
                        'surface-bright': 'surfaceBright',
                        'surface-variant': 'surfaceVariant',
                        'on-surface-variant': 'onSurfaceVariant',
                        outline: 'outline',
                        'outline-variant': 'outlineVariant',
                        'surface-container-lowest': 'surfaceContainerLowest',
                        'surface-container-low': 'surfaceContainerLow',
                        'surface-container': 'surfaceContainer',
                        'surface-container-high': 'surfaceContainerHigh',
                        'surface-container-highest': 'surfaceContainerHighest',
                        'inverse-surface': 'inverseSurface',
                        'inverse-on-surface': 'inverseOnSurface',
                        'inverse-primary': 'inversePrimary',
                        scrim: 'scrim',
                        shadow: 'shadow'
                    }

                    Object.entries(tokenMap).forEach(([cssToken, md3Token]) => {
                        let colorValue = scheme[md3Token]
                        if (colorValue === undefined) return

                        const unsignedValue = colorValue >>> 0
                        const r = (unsignedValue >> 16) & 255
                        const g = (unsignedValue >> 8) & 255
                        const b = unsignedValue & 255

                        setCssVariable(
                            '--dynamic-' + cssToken,
                            'rgb(' + r + ', ' + g + ', ' + b + ')'
                        )
                    })
                } catch (error) {
                    console.error('Error applying dynamic colors:', error)
                }
            }

            function init() {
                if (themeSetting === 'auto') {
                    const hour = new Date().getHours()
                    const theme = hour >= 19 || hour < 6 ? 'dark' : 'light'
                    applyTheme(theme)
                } else {
                    applyTheme(themeSetting)
                }

                const img = document.getElementById('dynamic-color-source')
                img.setAttribute('crossOrigin', '')

                 try {
                    const palette = colorThief.getPalette(
                        img,
                        5,
                        10
                    )
                    const color =
                        palette[Math.floor(Math.random() * palette.length)]
                    applyDynamicColors(color)
                } catch (e) {
                    console.error('Error extracting color:', e)
                    applyDynamicColors(defaultSourceColor)
                }
            }

            init()
        </script>
    </body>
</html>
